<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web3 — Rule‑of‑5 Explorer</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#101620;--panel-2:#0f141d;--mute:#91a1b3;--text:#ecf3ff;--accent:#6ad1ff;--accent-2:#abffcb;--warning:#ffd166;--shadow:rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -10%, #112, transparent 60%), var(--bg);color:var(--text);font:16px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    header{position:sticky;top:0;z-index:3;background:linear-gradient(180deg, rgba(10,14,20,.9), rgba(10,14,20,.6));backdrop-filter: blur(10px);border-bottom:1px solid #1b2330}
    .hwrap{max-width:1200px;margin:0 auto;padding:18px 20px;display:grid;grid-template-columns: 1fr auto;gap:16px;align-items:center}
    h1{font-size:20px;margin:0;letter-spacing:.3px}
    h1 span{opacity:.7;font-weight:500}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #263142;padding:6px 10px;border-radius:999px;color:var(--mute);font-size:12px}
    .layout{max-width:1200px;margin:22px auto;display:grid;grid-template-columns: 360px 1fr;gap:18px;padding:0 20px}
    aside{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1a2432;border-radius:var(--radius);box-shadow:0 12px 40px var(--shadow)}
    .controls{padding:14px;border-bottom:1px solid #182132;display:grid;gap:10px}
    .controls input[type="search"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #223042;background:#0c111a;color:var(--text)}
    .controls .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #223042;background:#0c111a;color:var(--text);padding:8px 10px;border-radius:12px;font-size:12px;cursor:pointer}
    .btn:hover{border-color:#2f415a}
    .btn.primary{background:linear-gradient(180deg,#0e1a27,#0b1420);border-color:#2a3a50;color:#cfe8ff}
    .btn.ghost{background:transparent}
    .meter{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{border:1px dashed #254; padding:4px 8px; border-radius:10px; font-size:12px; color:#a8ffd7; background:rgba(40,90,70,.12)}

    .tree{max-height:70vh;overflow:auto;padding:10px 14px}
    details{padding:4px 6px;border-radius:10px}
    details[open]{background:linear-gradient(180deg, rgba(120,200,255,.06), transparent)}
    summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:10px}
    summary::-webkit-details-marker{display:none}
    .node{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;width:100%}
    .title{font-weight:600}
    .level{font-size:11px;color:var(--mute)}
    .hint{font-size:11px;color:#a4b7cf}
    .tag{font-size:10px;border:1px solid #2a3b52;border-radius:999px;padding:2px 6px;color:#b2c7e5}
    .blurb{margin:4px 0 8px 28px;color:#bcd1eb;font-size:13px}
    .children{margin-left:22px;border-left:1px dashed #26445a;padding-left:8px}
    .bullet{display:inline-block;width:9px;height:9px;border:2px solid var(--accent);border-radius:50%;}
    .match{background:rgba(255, 209, 102, .15);border-bottom:1px dashed var(--warning)}

    main{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1a2432;border-radius:var(--radius);box-shadow:0 12px 40px var(--shadow);min-height:70vh}
    .pane{display:grid;grid-template-rows:auto 1fr;}
    .detail{padding:18px 20px}
    .breadcrumb{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .crumb{font-size:12px;color:#bcd1eb}
    .crumb:not(:last-child)::after{content:"›";opacity:.5;margin:0 6px}
    .title2{margin:8px 0 6px;font-size:22px}
    .desc{color:#cfe0fa;opacity:.95}

    .kv{display:grid;grid-template-columns: 160px 1fr;gap:8px;margin-top:14px}
    .kv div:nth-child(odd){color:#8fa9c9}

    .foot{border-top:1px solid #182132;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;color:#9bb1cc}
    .small{font-size:12px;color:#90a7c7}
    .accent{color:var(--accent)}
    .accent2{color:var(--accent-2)}
    .note{font-size:12px;color:#8aa0bf}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0a111a;border:1px solid #223042;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header>
  <div class="hwrap">
    <h1>Web3 — <span>Rule‑of‑5 Knowledge Explorer</span></h1>
    <div class="badge" title="Each concept expands into 5 sub-concepts up to 5 levels">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
      Max Depth: 5
    </div>
  </div>
</header>

<div class="layout">
  <aside>
    <div class="controls">
      <input id="q" type="search" placeholder="Search concepts… (try: identity, DAOs, NFTs)" />
      <div class="row">
        <button class="btn" onclick="expandTo(1)">Level 1</button>
        <button class="btn" onclick="expandTo(2)">Level 2</button>
        <button class="btn" onclick="expandTo(3)">Level 3</button>
        <button class="btn" onclick="expandTo(4)">Level 4</button>
        <button class="btn" onclick="expandTo(5)">Level 5</button>
        <button class="btn ghost" onclick="collapseAll()">Collapse All</button>
      </div>
      <div class="row">
        <button class="btn primary" onclick="downloadJSON()">Export JSON</button>
        <span class="note">Tip: <span class="kbd">/</span> focuses search</span>
      </div>
      <div class="meter" id="meter"></div>
    </div>
    <div class="tree" id="tree"></div>
  </aside>

  <main class="pane">
    <div class="detail" id="detail">
      <div class="breadcrumb" id="crumbs"></div>
      <h2 class="title2" id="d-title">Welcome to Web3 Rule‑of‑5</h2>
      <p class="desc" id="d-desc">Start on the left by expanding nodes. Each concept fans out into exactly five sub‑concepts. Use the controls to expand to a target depth, search for any term, or export the entire map as JSON.</p>
      <div class="kv" id="d-kv"></div>
    </div>
    <div class="foot">
      <div class="small">Designed for clarity • Progressive disclosure • 
        <span class="accent">5× branching</span> up to <span class="accent2">5 levels</span>
      </div>
      <div class="small">Built with HTML/CSS/JS — no external libraries</div>
    </div>
  </main>
</div>

<script>
// ---------- Knowledge Model (curated for 3 levels; auto-generates deeper) ----------
const MAX_DEPTH = 5;
function node(t, blurb, children=[]) {return {title:t, blurb, children};}

const data = node("Web3", "A user-empowering internet that encodes trust and value natively using cryptography, blockchains, and open protocols.", [
  node("Foundations & Principles", "The philosophies and properties that make Web3 distinct from Web2.", [
    node("Decentralization", "Shift of control from single authorities to distributed participants.", []),
    node("Trust & Security", "Trust arises from math and incentives rather than intermediaries.", []),
    node("Identity & Privacy", "Self‑sovereign identity (SSI) and selective disclosure with modern cryptography.", []),
    node("Governance & DAOs", "On‑chain rules and token‑holder voting coordinate groups transparently.", []),
    node("Interoperability", "Composability and cross‑chain bridges enable ecosystems to connect.", [])
  ]),
  node("Blockchain Infrastructure", "Systems that run the ledger, scale throughput, and store data.", [
    node("Layer‑1 Blockchains", "Base networks like Ethereum, Solana, Cosmos zones, etc.", []),
    node("Layer‑2 Scalability", "Rollups and channels that increase capacity while inheriting L1 security.", []),
    node("Consensus Mechanisms", "Protocols (PoS, PoW, etc.) to agree securely on the ledger state.", []),
    node("Storage & Data", "Decentralized storage such as IPFS/Filecoin; indexers and data availability.", []),
    node("Networking & Nodes", "Peer‑to‑peer networking, clients, validators, and node operations.", [])
  ]),
  node("Smart Contracts & Protocols", "Programmable agreements and the standards that make them interoperable.", [
    node("Languages & VMs", "Solidity, Vyper, Move; EVM and WASM execution.", []),
    node("Oracles & Off‑chain", "Bring external data/computation on‑chain securely.", []),
    node("Standards & Interfaces", "Token and protocol interfaces (e.g., ERCs) that enable composability.", []),
    node("Verification & Testing", "Audits, fuzzing, formal proofs to reduce vulnerabilities.", []),
    node("Upgradeability & Patterns", "Proxy patterns, governance‑gated changes, safe migration.", [])
  ]),
  node("Digital Assets & Tokenomics", "Design of tokens, incentives, and value capture.", [
    node("Fungible Tokens", "Interchangeable assets used for utility, governance, or payments.", []),
    node("Non‑Fungible Tokens (NFTs)", "Unique assets representing art, tickets, identity, or RWAs.", []),
    node("Stablecoins", "Price‑stable tokens (fiat‑backed, crypto‑collateralized, or algorithmic).", []),
    node("Treasury & DAOs", "On‑chain treasuries, voting power, and capital allocation.", []),
    node("Incentives & Game Theory", "Token emissions, staking, and mechanism design to align behavior.", [])
  ]),
  node("Applications & Ecosystems", "User‑facing use cases and the surrounding landscape.", [
    node("DeFi", "Open financial primitives: exchange, lending, derivatives, asset management.", []),
    node("Web3 Social", "User‑owned graphs, portable handles, creator monetization.", []),
    node("Gaming & Metaverse", "Playable economies, digital ownership, interoperable assets.", []),
    node("Supply Chain & RWAs", "Track provenance and tokenize real‑world assets.", []),
    node("Regulation & Compliance", "KYC/AML approaches, travel‑rule tools, and policy trends.", [])
  ])
]);

// Tailored level‑3 → level‑4 expansions (curated examples)
const curatedL4 = {
  "Decentralization": [
    ["Node Diversity","Many independent operators reduce capture risk."],
    ["Censorship Resistance","Hard to block transactions or exclude users."],
    ["Fault Tolerance","No single point whose failure halts the network."],
    ["Edge vs Cloud","Favor local control over centralized hosting."],
    ["Trade‑offs","Latency, UX, and costs can rise with distribution."]
  ],
  "Trust & Security": [
    ["Cryptography Basics","Hashes, signatures, and Merkle proofs secure state."],
    ["Key Management","Seed phrases, hardware wallets, MPC custody."],
    ["Audits","Independent reviews to catch vulnerabilities early."],
    ["Bug Bounties","Reward white‑hats for responsible disclosure."],
    ["Attack Vectors","Reentrancy, price oracles, MEV, governance attacks."]
  ],
  "Identity & Privacy": [
    ["DIDs & VCs","Decentralized identifiers and verifiable credentials."],
    ["Selective Disclosure","Prove attributes without leaking everything."],
    ["Zero‑Knowledge","ZKPs enable private yet verifiable statements."],
    ["Reputation Graphs","On‑chain history and attestations signal trust."],
    ["UX of Keys","Recovery, social guardians, and account abstraction."]
  ],
  "Governance & DAOs": [
    ["Voting Systems","1‑token‑1‑vote, quadratic, conviction voting, etc."],
    ["Delegation","Elect stewards to scale decisions and expertise."],
    ["Constitution","Rules of change and conflict resolution on‑chain."],
    ["Treasury Controls","Safeguards, multisigs, timelocks, and audits."],
    ["Participation","Incentives and rituals that keep members engaged."]
  ],
  "Interoperability": [
    ["Bridges","Move assets/messages across chains securely."],
    ["Standards","Common token and contract interfaces reduce friction."],
    ["Shared Security","Consumer chains borrow security from a hub."],
    ["Cross‑chain Apps","Single UX spanning multiple networks."],
    ["Risks","Bridge exploits and fragmented liquidity."]
  ],

  "Layer‑1 Blockchains": [
    ["Execution","How transactions run (EVM, WASM, parallelism)."],
    ["Data Availability","Guarantee that block data is retrievable."],
    ["Finality","Economic or probabilistic guarantees of permanence."],
    ["Client Diversity","Multiple implementations reduce correlated bugs."],
    ["Token Utility","Fee, staking, governance use for native token."]
  ],
  "Layer‑2 Scalability": [
    ["Optimistic Rollups","Assume validity; fraud proofs challenge bad blocks."],
    ["ZK Rollups","Validity proofs ensure correctness without re‑execution."],
    ["State Channels","Peer sets transact off‑chain, settle periodically."],
    ["Shared Sequencing","Fair ordering and reduced MEV on L2s."],
    ["Bridging UX","Fast exits, liquidity providers, security caveats."]
  ],
  "Consensus Mechanisms": [
    ["PoS Staking","Validators bond tokens and get slashed for faults."],
    ["Leader Election","VRF/round‑robin select block proposers fairly."],
    ["Finality Gadgets","Checkpoint mechanisms to lock history."],
    ["Sybil Resistance","Costs (stake/work/identity) deter spam."] ,
    ["Incentive Design","Rewards and penalties align honest behavior."]
  ],
  "Storage & Data": [
    ["IPFS Basics","Content addressing with hashes, not locations."],
    ["Filecoin/Economics","Markets that pay for durable storage."],
    ["Indexing/Subgraphs","Queryable views for dApps."] ,
    ["Data Availability Layers","Specialized chains for blob/data posting."],
    ["Privacy Layers","Encrypted storage and access control."]
  ],
  "Networking & Nodes": [
    ["P2P Gossip","Propagate blocks/tx quickly and reliably."],
    ["Light Clients","Verify with minimal resources (SPV/ZK‑LC)."],
    ["Validator Ops","Uptime, monitoring, backups, key safety."],
    ["RPC & Infra","Gateways, rate limits, and decentralization."],
    ["Observability","Mempool, logs, metrics, and alerts."]
  ],

  "Languages & VMs": [
    ["Type Safety","Catch bugs earlier; avoid foot‑guns."],
    ["Gas Model","Meter computation/storage to prevent abuse."],
    ["WASM Runtimes","Multi‑language smart contracts via WASM."],
    ["Parallel Execution","Increase throughput with safe concurrency."],
    ["Toolchains","Compilers, linters, formatters, IDE support."]
  ],
  "Oracles & Off‑chain": [
    ["Price Feeds","Reliable asset prices for DeFi protocols."],
    ["Compute Networks","Off‑chain tasks with verifiable outputs."],
    ["Randomness","Unbiasable randomness for lotteries/games."],
    ["Bridge Security","Economic security and multi‑sig risks."],
    ["Data Integrity","Signing, attestation, replay protection."]
  ],
  "Standards & Interfaces": [
    ["ERC‑20","Fungible token interface for transfers/allowance."],
    ["ERC‑721/1155","Non‑fungible and semi‑fungible standards."],
    ["Permit/EIP‑2612","Gasless approvals via signatures."],
    ["Meta‑Tx","Relayers pay gas; better UX."],
    ["Composability","Plug‑and‑play across protocols."]
  ],
  "Verification & Testing": [
    ["Unit/Property Tests","Check behavior and invariants."],
    ["Fuzzing","Generate random inputs to find edge cases."],
    ["Symbolic Exec","Explore paths mathematically for bugs."],
    ["Formal Proofs","Machine‑checked correctness proofs."],
    ["Runtime Guards","Circuit breakers, pause switches, rate limits."]
  ],
  "Upgradeability & Patterns": [
    ["Proxy Pattern","Separate logic and storage for upgrades."],
    ["Governance Gates","Timelocks and voting for changes."],
    ["Migration Plans","Safely move funds/state to new versions."],
    ["Modularity","Composable components reduce risk."],
    ["Backward Compat","Avoid breaking dependents."]
  ],

  "Fungible Tokens": [
    ["Utility","Pay fees, access services, or reward usage."],
    ["Governance","Vote on parameters, elect delegates."],
    ["Liquidity","Pools enable trading and price discovery."],
    ["Distribution","Airdrops, sales, and vesting schedules."],
    ["Compliance","Transfer restrictions, blacklists, disclosures."]
  ],
  "Non‑Fungible Tokens (NFTs)": [
    ["Metadata","On/off‑chain storage and mutability choices."],
    ["Royalties","Creator revenue models and enforcement."],
    ["Tickets/Access","Memberships and event passes."],
    ["Identity","Soulbound/attestation‑style credentials."],
    ["RWAs","Tokenize property, collectibles, certificates."]
  ],
  "Stablecoins": [
    ["Fiat‑Backed","Off‑chain reserves and attestations."],
    ["Crypto‑Collateral","Over‑collateralized, on‑chain transparency."],
    ["Algorithmic","Supply rules target a peg (high risk)."],
    ["Payment Rails","Low‑cost global settlement."],
    ["Policy Risks","Regulatory oversight and bank integration."]
  ],
  "Treasury & DAOs": [
    ["Budgeting","Fund roadmaps, grants, and ops."],
    ["Diversification","Manage exposure and risk."],
    ["Transparency","On‑chain accounting and dashboards."],
    ["Security","Multisigs, MPC, insurance coverage."],
    ["Compensation","Contributor rewards and vesting."]
  ],
  "Incentives & Game Theory": [
    ["Staking","Lock tokens for yield and security."],
    ["Liquidity Mining","Reward LPs for providing depth."],
    ["Fee Sharing","Split protocol revenues with users."],
    ["Anti‑Sybil","Deter fake accounts and farming."],
    ["Sustainability","Avoid ponzinomics; align long‑term."]
  ],

  "DeFi": [
    ["DEXs","AMMs and order books for swaps."],
    ["Lending","Over‑collateralized loans and credit primitives."],
    ["Derivatives","Perps, options, and structured products."],
    ["Asset Management","Vaults and auto‑rebalancing strategies."],
    ["Risk Management","Oracles, LTVs, liquidations, insurance."]
  ],
  "Web3 Social": [
    ["Portable Handles","Usernames/IDs you can take anywhere."],
    ["Social Graphs","Open, user‑owned follower relations."],
    ["Creator Monetization","Tokens, tipping, and revenue shares."],
    ["Moderation","Community rules, client‑side filters."],
    ["Interoperable Feeds","Multiple apps over the same graph."]
  ],
  "Gaming & Metaverse": [
    ["Asset Ownership","Players truly own items/skins."],
    ["Economy Design","Sinks/sources and inflation control."],
    ["Interoperability","Use assets across games/worlds."],
    ["On/Off‑chain Mix","Latency‑friendly hybrids for UX."],
    ["Anti‑Cheat","Proofs and attestations for fairness."]
  ],
  "Supply Chain & RWAs": [
    ["Provenance","Track origin and custody changes."],
    ["Tokenization","On‑chain representation of assets."] ,
    ["Compliance Rails","Whitelists and attested participants."],
    ["Oracles","Verified real‑world events and data."],
    ["Settlement","Atomic delivery‑versus‑payment."]
  ],
  "Regulation & Compliance": [
    ["KYC/AML","Know‑your‑customer and anti‑laundering checks."],
    ["Travel Rule","Share originator/beneficiary data between VASPs."],
    ["Licensing","Exchange/custody requirements by jurisdiction."],
    ["Taxation","Gains, reporting, and cost basis."],
    ["Policy Trends","Global coordination and sandboxes."]
  ],
  "Consensus Mechanisms": [
    ["PoS Staking","Validators bond tokens and get slashed for faults."],
    ["Leader Election","VRF/round‑robin select block proposers fairly."],
    ["Finality Gadgets","Checkpoint mechanisms to lock history."],
    ["Sybil Resistance","Costs (stake/work/identity) deter spam."],
    ["Incentive Design","Rewards and penalties align honest behavior."]
  ]
};

const curatedL5 = {
  "PoS Staking": [
    ["Principles","Security from economic stake rather than computation."],
    ["Practices","Delegated staking, validator rotation, slashing."],
    ["Tools","Ethereum Beacon Chain, Cosmos SDK staking modules."],
    ["Risks","Centralization of stake, long‑range attacks."],
    ["Examples","ETH2 validators, Cosmos Hub staking."]
  ],
  "Leader Election": [
    ["Principles","Fair randomness to choose block proposers."],
    ["Practices","Use VRFs, round‑robin, or committee selection."],
    ["Tools","Algorand VRF, Ouroboros Praos."],
    ["Risks","Bias in randomness, grinding attacks."],
    ["Examples","Algorand consensus, Cardano leader slots."]
  ],
  "Finality Gadgets": [
    ["Principles","Checkpoints and votes give strong finality guarantees."],
    ["Practices","Two‑phase commit, BFT voting rounds."],
    ["Tools","Casper FFG, GRANDPA."],
    ["Risks","Network partitions delaying votes."],
    ["Examples","Ethereum finality, Polkadot GRANDPA."]
  ],
  "Sybil Resistance": [
    ["Principles","Prevent cheap creation of fake identities."],
    ["Practices","Require economic cost (stake/work/identity proofs)."],
    ["Tools","Proof of Work, Proof of Stake, Proof of Authority."],
    ["Risks","Wealth concentration, energy waste."],
    ["Examples","Bitcoin PoW, Ethereum PoS, POA networks."]
  ],
  "Incentive Design": [
    ["Principles","Align validator rewards with honest participation."],
    ["Practices","Block rewards, transaction fees, penalties."],
    ["Tools","Tokenomics modules in protocol code."],
    ["Risks","Misaligned incentives causing forks or attacks."],
    ["Examples","Ethereum gas fees, Cosmos inflationary rewards."]
  ]
};

// ---------- Auto‑expansion template for generic deeper levels ----------
function templatedChildrenFor(title){
  // If curated L5 exists, return it
  if(curatedL5[title]) return curatedL5[title];
  return [
    ["Principles", `Core principles that guide ${title}.`],
    ["Practices", `Tactics and routines to implement ${title}.`],
    ["Tools", `Common tools, libraries, and platforms for ${title}.`],
    ["Risks", `Typical pitfalls and threat models related to ${title}.`],
    ["Examples", `Concrete scenarios that demonstrate ${title} in action.`]
  ];
}


// ---------- Rendering & Interaction ----------
const treeEl = document.getElementById('tree');
const meterEl = document.getElementById('meter');
const searchEl = document.getElementById('q');
const detail = {
  crumbs: document.getElementById('crumbs'),
  title: document.getElementById('d-title'),
  desc: document.getElementById('d-desc'),
  kv: document.getElementById('d-kv')
};

function ensureFive(nodeObj, depth){
  // If no children and depth < MAX, generate from curated or generic templates
  if(!nodeObj.children) nodeObj.children = [];
  if(nodeObj.children.length===0 && depth < MAX_DEPTH){
    const curated = curatedL4[nodeObj.title];
    const items = curated || templatedChildrenFor(nodeObj.title);
    nodeObj.children = items.slice(0,5).map(([t,b])=>node(`${t}`, b, []));
  }
  // If fewer than 5 but exists (authoring mistake), pad generically
  while(nodeObj.children.length<5 && depth < MAX_DEPTH){
    const idx = nodeObj.children.length+1;
    nodeObj.children.push(node(`Aspect ${idx}`, `Additional aspect of ${nodeObj.title}.`, []));
  }
}

function renderTree(){
  treeEl.innerHTML = '';
  const levelsCount = Array(MAX_DEPTH).fill(0);
  const q = (searchEl.value || '').trim().toLowerCase();

  function dfs(n, depth, path){
    const match = q && (n.title.toLowerCase().includes(q) || n.blurb.toLowerCase().includes(q));
    levelsCount[depth-1]++;

    const det = document.createElement('details');
    const sum = document.createElement('summary');
    const wrap = document.createElement('div');
    wrap.className = 'node';

    const bullet = document.createElement('span'); bullet.className='bullet';
    const ttl = document.createElement('div'); ttl.className='title'; ttl.textContent = n.title;
    const lvl = document.createElement('div'); lvl.className='level'; lvl.textContent = `L${depth}`;
    wrap.append(bullet, ttl, lvl);
    sum.appendChild(wrap);

    sum.addEventListener('click', (e)=>{
      e.preventDefault();
      det.open = !det.open;
      selectNode(n, path);
      if(det.open){ ensureFive(n, depth); childRender(); }
      saveOpenState();
    });

    det.appendChild(sum);
    const blurb = document.createElement('div'); blurb.className = 'blurb'; blurb.textContent = n.blurb; det.appendChild(blurb);

    const kids = document.createElement('div'); kids.className='children'; det.appendChild(kids);

    function childRender(){
      kids.innerHTML = '';
      if(depth >= MAX_DEPTH) return;
      n.children.slice(0,5).forEach((c,i)=>{
        const childPath=[...path,i];
        kids.appendChild(dfs(c, depth+1, childPath));
      });
    }

    if(match){ det.classList.add('match'); }

    return det;
  }

  treeEl.appendChild(dfs(data,1,[]));

  // restore expanded state
  restoreOpenState();

  // compute meter
  meterEl.innerHTML = '';
  for(let i=0;i<MAX_DEPTH;i++){
    const span = document.createElement('span');
    span.className='chip';
    span.textContent = `L${i+1}: ${levelsCount[i]} nodes`;
    meterEl.appendChild(span);
  }
}

function selectNode(n, path){
  // breadcrumbs
  detail.crumbs.innerHTML='';
  const names = getPathTitles(path);
  names.forEach((name, idx)=>{
    const span = document.createElement('span'); span.className='crumb'; span.textContent=name; detail.crumbs.appendChild(span);
  });
  // primary
  detail.title.textContent = n.title;
  detail.desc.textContent = n.blurb;
  // facts
  const depth = path.length+1;
  detail.kv.innerHTML='';
  addKV('Depth', `L${depth}`);
  addKV('Children', depth<MAX_DEPTH? '5 (rule‑of‑5)': '—');
  addKV('Path', names.join(' › '));
}
function addKV(k,v){
  const a=document.createElement('div'); a.textContent=k; const b=document.createElement('div'); b.textContent=v; detail.kv.append(a,b);
}
function getPathTitles(path){
  const names=['Web3'];
  let cur = data;
  for(const idx of path){
    if(!cur.children || !cur.children[idx]) break;
    cur = cur.children[idx];
    names.push(cur.title);
  }
  return names;
}

// Controls
function expandTo(target){
  // breadth‑first ensure
  function bfsEnsure(){
    const q=[[data,1]];
    while(q.length){
      const [n,d]=q.shift();
      if(d<target){ ensureFive(n,d); n._open=true; }
      if(d>=MAX_DEPTH) continue;
      (n.children||[]).forEach(c=>q.push([c,d+1]));
    }
  }
  bfsEnsure();
  renderTree();
}
function collapseAll(){
  function rec(n){ n._open=false; (n.children||[]).forEach(rec); }
  rec(data); renderTree();
}

// Search
searchEl.addEventListener('input', ()=>{ renderTree(); if(searchEl.value.trim()) expandTo(3); });
document.addEventListener('keydown', (e)=>{ if(e.key==='/' && document.activeElement!==searchEl){ e.preventDefault(); searchEl.focus(); } });

// Persist open state
function saveOpenState(){
  const state=[];
  function rec(n,path){
    if(n._open){ state.push(path.join('.')); }
    (n.children||[]).forEach((c,i)=>rec(c,[...path,i]));
  }
  rec(data,[]);
  localStorage.setItem('web3-open', JSON.stringify(state));
}
function restoreOpenState(){
  const state = JSON.parse(localStorage.getItem('web3-open')||'[]');
  const openSet = new Set(state);
  // Walk DOM details and open if path matches
  function walkDOM(el, path, n, depth){
    const det = el.querySelector(':scope > details');
    if(!det) return;
    const pKey = path.join('.');
    if(openSet.has(pKey)){
      det.open = true; n._open=true; ensureFive(n, depth); // ensure children exist
    }
    const kids = det.querySelector(':scope > .children');
    if(!kids) return;
    (n.children||[]).forEach((c,i)=>{
      // For now, render immediate child if needed
      const childEl = document.createElement('div'); kids.appendChild(childEl);
      // recursively build child subtree skeleton before checking open state
      const childDetails = buildDetails(c, depth+1, [...path, i]);
      kids.replaceChild(childDetails, childEl);
      walkDOM(childDetails, [...path, i], c, depth+1);
    });
  }
  // helper to build a single details block (like dfs but single node)
  function buildDetails(n, depth, path){
    const det = document.createElement('details');
    const sum = document.createElement('summary');
    const wrap = document.createElement('div'); wrap.className='node';
    const bullet=document.createElement('span'); bullet.className='bullet';
    const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent=n.title;
    const lvl=document.createElement('div'); lvl.className='level'; lvl.textContent=`L${depth}`;
    wrap.append(bullet,ttl,lvl); sum.appendChild(wrap);
    sum.addEventListener('click', (e)=>{e.preventDefault(); det.open=!det.open; selectNode(n, path); if(det.open){ ensureFive(n, depth); // render children now
        const kids = det.querySelector(':scope > .children'); kids.innerHTML='';
        n.children.slice(0,5).forEach((c,i)=>kids.appendChild(buildDetails(c, depth+1, [...path,i])));
      } saveOpenState(); });
    det.appendChild(sum);
    const blurb=document.createElement('div'); blurb.className='blurb'; blurb.textContent=n.blurb; det.appendChild(blurb);
    const kids=document.createElement('div'); kids.className='children'; det.appendChild(kids);
    return det;
  }
  // Repaint from scratch with preserved states
  treeEl.innerHTML='';
  const root = buildDetails(data,1,[]); treeEl.appendChild(root);
  walkDOM(treeEl.firstElementChild, [], data, 1);
  updateMeter();
}
function updateMeter(){
  const counts = [0,0,0,0,0];
  function rec(n,depth){ counts[depth-1]++; (n.children||[]).forEach(c=>rec(c,depth+1)); }
  rec(data,1);
  meterEl.innerHTML='';
  counts.forEach((c,i)=>{ const span=document.createElement('span'); span.className='chip'; span.textContent=`L${i+1}: ${c} nodes`; meterEl.appendChild(span); });
}

function downloadJSON(){
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='web3-rule-of-5.json'; a.click(); URL.revokeObjectURL(url);
}

// Initialize view
renderTree();
expandTo(2);
selectNode(data, []);
</script>
</body>
</html>
